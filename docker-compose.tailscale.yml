# Tailscale Container Service with Caddy Reverse Proxy
#
# This setup provides:
#   - Tailscale daemon for secure HTTPS access via MagicDNS
#   - Caddy reverse proxy for multi-service routing
#
# Route paths:
#   /chronicle/* -> Chronicle backend (ws_pcm, api, etc.)
#   /api/*       -> Ushadow backend API
#   /auth/*      -> Ushadow backend auth
#   /ws_pcm      -> Ushadow WebSocket
#   /*           -> Ushadow frontend
#
# Usage:
#   docker compose -f docker-compose.tailscale.yml up -d
#
# Or include in your main compose:
#   docker compose -f docker-compose.infra.yml -f docker-compose.tailscale.yml up -d

services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: ushadow-tailscale
    hostname: ushadow-tailscale
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      # Do not set TS_AUTHKEY - we'll use interactive auth with QR code
      - TS_ACCEPT_DNS=true
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
    volumes:
      # Persist Tailscale state across container restarts
      - tailscale-state:/var/lib/tailscale
      # Mount config for certificate storage
      - ./config/certs:/certs
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - infra-network
    restart: unless-stopped
    # Keep container running even if Tailscale isn't authenticated yet
    command: sh -c "tailscaled --tun=userspace-networking --statedir=/var/lib/tailscale & sleep infinity"
    depends_on:
      caddy:
        condition: service_healthy

  caddy:
    image: caddy:2-alpine
    container_name: ushadow-caddy
    ports:
      # Internal port - Tailscale Serve forwards HTTPS here
      - "8880:80"
    volumes:
      - ./config/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/proxy-health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  tailscale-state:
    name: ushadow-tailscale-state
  caddy_data:
    name: ushadow-caddy-data
  caddy_config:
    name: ushadow-caddy-config

networks:
  infra-network:
    external: true
