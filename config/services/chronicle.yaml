# Chronicle Service Definition
# Conversation engine with audio processing and AI analysis
#
# Chronicle USES capabilities rather than directly referencing credentials.
# The CapabilityResolver wires in the selected provider's credentials at deploy time.

id: chronicle
name: "Chronicle"
description: "AI-powered conversation processing with transcription and analysis"
version: ">=1.0.0"

# =============================================================================
# CAPABILITIES THIS SERVICE USES
# =============================================================================
# Chronicle declares what it NEEDS, not which specific providers.
# The wizard lets users choose providers (OpenAI vs Anthropic, Deepgram vs Whisper)
# and the resolver injects the correct credentials.

uses:
  # LLM for conversation analysis and summarization
  - capability: llm
    required: true
    purpose: "Conversation analysis, summarization, and entity extraction"
    # No env_mapping needed - Chronicle uses OpenAI SDK natively
    # When using openai/openai-compatible providers, env vars match directly
    # For other providers (anthropic, ollama), add env_mapping to translate

  # Transcription for speech-to-text
  - capability: transcription
    required: true
    purpose: "Real-time speech-to-text transcription"
    # No env_mapping needed - Chronicle uses Deepgram SDK natively

  # Memory for storing conversations (optional)
  - capability: memory
    required: false
    purpose: "Long-term conversation memory and retrieval"
    # No env_mapping - memory provider env vars pass through directly

# =============================================================================
# DOCKER CONFIGURATION
# =============================================================================
docker:
  image: ghcr.io/chronicler-ai/chronicle:latest
  compose_file: compose/chronicle-compose.yaml
  service_name: chronicle-backend

  ports:
    - container: 8000
      host: 8000
      protocol: http

  health:
    http_get: /health
    port: 8000
    interval: 10s
    timeout: 5s
    retries: 5

  volumes:
    - name: chronicle-data
      path: /app/data
      persistent: true

# =============================================================================
# INFRASTRUCTURE DEPENDENCIES
# =============================================================================
# These are runtime dependencies (containers that must be running)
# Different from `uses:` which is about credentials/configuration

depends_on:
  required:
    - mongo      # Conversation storage
    - redis      # Queue and session management
    - qdrant     # Vector embeddings

# =============================================================================
# SERVICE-SPECIFIC CONFIGURATION
# =============================================================================
# These are Chronicle's own settings, not from capabilities

config:
  # Auth secret key for JWT tokens (shared with ushadow)
  - key: auth_secret_key
    env_var: AUTH_SECRET_KEY
    settings_path: security.auth_secret_key

  # Admin password (shared with ushadow)
  - key: admin_password
    env_var: ADMIN_PASSWORD
    settings_path: admin.password

  # MongoDB connection
  - key: mongodb_uri
    env_var: MONGODB_URI
    settings_path: infrastructure.mongodb_uri
    default: "mongodb://mongo:27017"

  - key: mongodb_database
    env_var: MONGODB_DATABASE
    settings_path: infrastructure.mongodb_database
    default: "chronicle"

  # Redis connection
  - key: redis_url
    env_var: REDIS_URL
    settings_path: infrastructure.redis_url
    default: "redis://redis:6379/0"

  # Qdrant connection
  - key: qdrant_host
    env_var: QDRANT_BASE_URL
    settings_path: infrastructure.qdrant_base_url
    default: "qdrant"

  - key: qdrant_port
    env_var: QDRANT_PORT
    settings_path: infrastructure.qdrant_port
    default: "6333"

  # CORS for frontend
  - key: cors_origins
    env_var: CORS_ORIGINS
    settings_path: network.cors_origins

# =============================================================================
# UI METADATA
# =============================================================================
ui:
  icon: microphone
  category: conversation_engine
  is_default: true
  wizard_order: 1
  tags: ["conversation", "transcription", "audio", "ai"]

  links:
    docs: https://github.com/chronicler-ai/chronicle
