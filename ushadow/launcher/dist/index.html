<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ushadow</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #0f0f13;
      color: #f4f4f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .container {
      max-width: 900px;
      width: 100%;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 700px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4ade80 0%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .logo p {
      color: #71717a;
      font-size: 0.9rem;
    }

    .card {
      background: #1a1a21;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid #3d3d4a;
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #f4f4f5;
    }

    .check-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #2d2d3a;
    }

    .check-item:last-child {
      border-bottom: none;
    }

    .check-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      font-size: 0.8rem;
    }

    .check-icon.success { background: #4ade80; color: #0f0f13; }
    .check-icon.error { background: #f87171; color: #0f0f13; }
    .check-icon.pending { background: #52525b; animation: pulse 1.5s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .check-info {
      flex: 1;
    }

    .check-name {
      font-weight: 500;
      color: #f4f4f5;
    }

    .check-version {
      font-size: 0.75rem;
      color: #71717a;
    }

    .check-action {
      margin-left: auto;
    }

    .check-action a {
      color: #4ade80;
      text-decoration: none;
      font-size: 0.85rem;
    }

    .check-action a:hover {
      text-decoration: underline;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: #252530;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #52525b;
    }

    .status-dot.running { background: #4ade80; animation: pulse 2s infinite; }
    .status-dot.stopped { background: #f87171; }
    .status-dot.starting { background: #fbbf24; animation: pulse 0.5s infinite; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      width: 100%;
    }

    .btn-primary {
      background: #4ade80;
      color: #0f0f13;
    }

    .btn-primary:hover:not(:disabled) {
      background: #86efac;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
    }

    .btn-secondary {
      background: #252530;
      color: #f4f4f5;
      border: 1px solid #3d3d4a;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #2d2d3a;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 0.75rem;
    }

    .btn-group .btn {
      flex: 1;
    }

    .log-area {
      background: #0f0f13;
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      max-height: 150px;
      overflow-y: auto;
      color: #4ade80;
      border: 1px solid #3d3d4a;
    }

    .log-area .error { color: #f87171; }
    .log-area .info { color: #60a5fa; }

    .hidden { display: none; }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-banner {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #fca5a5;
      font-size: 0.875rem;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .padlock-btn {
      background: #252530;
      border: 1px solid #3d3d4a;
      border-radius: 8px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .padlock-btn:hover {
      background: #2d2d3a;
      border-color: #52525b;
    }

    .padlock-btn.secure {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .padlock-btn.secure:hover {
      background: rgba(74, 222, 128, 0.2);
    }

    .padlock-icon {
      width: 24px;
      height: 24px;
      color: #fbbf24;
    }

    .padlock-btn.secure .padlock-icon {
      color: #4ade80;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid #3d3d4a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: #71717a;
    }

    .footer-url {
      font-family: 'Monaco', 'Menlo', monospace;
      color: #a1a1aa;
    }

    .footer-url.secure {
      color: #4ade80;
    }

    .services-list {
      margin: 1rem 0;
      padding: 0;
    }

    .service-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #2d2d3a;
      font-size: 0.85rem;
    }

    .service-item:last-child {
      border-bottom: none;
    }

    .service-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 0.75rem;
      background: #52525b;
    }

    .service-icon.running { background: #4ade80; }
    .service-icon.stopped { background: #f87171; }
    .service-icon.starting { background: #fbbf24; animation: pulse 0.5s infinite; }

    .service-name {
      flex: 1;
      color: #a1a1aa;
    }

    .service-status {
      font-size: 0.75rem;
      color: #71717a;
    }

    .env-badge {
      display: inline-block;
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    /* Environment Cards */
    .env-card {
      background: #1a1a21;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 2px solid #3d3d4a;
      transition: all 0.2s;
    }

    .env-card:hover {
      border-color: #52525b;
      transform: translateY(-2px);
    }

    .env-card.running {
      border-color: currentColor;
      border-opacity: 0.5;
    }

    .env-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .env-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    .env-name {
      font-weight: 600;
      font-size: 1.1rem;
      text-transform: capitalize;
    }

    .env-urls {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.8rem;
      font-family: 'Monaco', 'Menlo', monospace;
    }

    .env-url {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #a1a1aa;
    }

    .env-url a {
      color: inherit;
      text-decoration: none;
    }

    .env-url a:hover {
      color: #f4f4f5;
      text-decoration: underline;
    }

    .env-url-label {
      color: #71717a;
      font-size: 0.7rem;
      min-width: 60px;
    }

    .env-url-icon {
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }

    .env-actions {
      margin-top: 0.75rem;
      display: flex;
      gap: 0.5rem;
    }

    .env-open-btn {
      flex: 1;
      padding: 0.5rem 1rem;
      background: #252530;
      color: #f4f4f5;
      border: 1px solid;
      border-color: currentColor;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .env-open-btn:hover {
      background: #2d2d3a;
      transform: translateY(-1px);
    }

    .env-open-btn svg {
      width: 14px;
      height: 14px;
    }

    .env-icon-btn {
      padding: 0.5rem;
      background: #252530;
      color: #71717a;
      border: 1px solid #3d3d4a;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 38px;
    }

    .env-icon-btn:hover {
      background: #2d2d3a;
      color: #a1a1aa;
    }

    .env-icon-btn.secure {
      color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .env-icon-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Color mappings for environments */
    .env-color-blue { color: #60a5fa; }
    .env-color-purple { color: #a855f7; }
    .env-color-green { color: #4ade80; }
    .env-color-red { color: #f87171; }
    .env-color-orange { color: #fb923c; }
    .env-color-yellow { color: #fbbf24; }
    .env-color-pink { color: #f472b6; }
    .env-color-cyan { color: #22d3ee; }
    .env-color-teal { color: #2dd4bf; }
    .env-color-indigo { color: #818cf8; }
    .env-color-default { color: #a1a1aa; }

    /* No environments message */
    .no-envs {
      text-align: center;
      color: #71717a;
      padding: 2rem;
      font-size: 0.9rem;
    }

    .column-header {
      font-size: 0.85rem;
      font-weight: 600;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #3d3d4a;
    }

    /* Collapsible prerequisites */
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .card-header h2 {
      margin-bottom: 0;
    }

    .card-toggle {
      background: none;
      border: none;
      color: #71717a;
      cursor: pointer;
      padding: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
    }

    .card-toggle:hover {
      color: #a1a1aa;
    }

    .card-toggle svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
    }

    .card.collapsed .card-toggle svg {
      transform: rotate(-90deg);
    }

    .card-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s;
      max-height: 500px;
      opacity: 1;
    }

    .card.collapsed .card-content {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
    }

    #prerequisites-section.collapsed .card-toggle svg {
      transform: rotate(-90deg);
    }

    #prerequisites-section .card-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s;
      max-height: 500px;
      opacity: 1;
    }

    #prerequisites-section.collapsed .card-content {
      max-height: 0;
      opacity: 0;
      margin-top: 0 !important;
    }

    .prereq-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #4ade80;
    }

    .prereq-status.warning {
      color: #fbbf24;
    }

    .prereq-status.error {
      color: #f87171;
    }

    /* Launch Button */
    .launch-btn {
      padding: 1.5rem 2rem;
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4ade80 0%, #a855f7 100%);
      color: #0f0f13;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin: 2rem 0;
      box-shadow: 0 8px 24px rgba(74, 222, 128, 0.3);
    }

    .launch-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(74, 222, 128, 0.4);
    }

    .launch-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .launch-container {
      grid-column: 1 / -1;
      text-align: center;
      transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }

    .launch-container.hiding {
      opacity: 0;
      transform: scale(0.95);
    }

    .launch-message {
      color: #71717a;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .create-env-btn {
      background: #a855f7;
      color: #f4f4f5;
    }

    .create-env-btn:hover:not(:disabled) {
      background: #c084fc;
    }

    /* Drawer animation */
    .two-column {
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      transform-origin: top;
    }

    .two-column.hidden {
      display: none;
      opacity: 0;
      transform: scaleY(0.9) translateY(-20px);
    }

    .two-column.showing {
      display: grid;
      animation: slideDown 0.5s ease-out forwards;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: scaleY(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scaleY(1) translateY(0);
      }
    }

    .card {
      transition: opacity 0.3s ease-out;
    }

    .card.creating {
      opacity: 0.7;
    }

    .creating-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      animation: pulse 1.5s infinite;
      width: 100%;
      margin-top: 1rem;
    }

    .creating-badge .spinner {
      margin: 0;
    }

    .btn.hidden {
      display: none;
    }

    /* Refresh button */
    .refresh-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #252530;
      border: 1px solid #3d3d4a;
      color: #a1a1aa;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 100;
    }

    .refresh-btn:hover {
      background: #2d2d3a;
      color: #f4f4f5;
      transform: scale(1.05);
    }

    .refresh-btn:active {
      transform: scale(0.95);
    }

    .refresh-btn.spinning svg {
      animation: spin 1s linear infinite;
    }

    .refresh-btn svg {
      width: 24px;
      height: 24px;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="logo.png" alt="Ushadow" style="height: 80px;" />
      <h1>Ushadow</h1>
      <p>Desktop Launcher</p>
    </div>

    <!-- Error Banner (hidden by default) -->
    <div class="error-banner hidden" id="error-banner"></div>

    <!-- Launch Container (shown when nothing is running) -->
    <div class="launch-container hidden" id="launch-container">
      <p class="launch-message">Ready to get started with Ushadow?</p>
      <button class="btn launch-btn" id="launch-btn" data-testid="launch-btn">
        üöÄ Launch Ushadow
      </button>
      <p class="launch-message" style="font-size: 0.85rem; margin-top: 1rem;">This will start infrastructure and create your first environment</p>
    </div>

    <!-- Two-Column Layout (hidden initially until status checked) -->
    <div class="two-column hidden">
      <!-- Left Column: Infrastructure -->
      <div class="card" id="infra-card">
        <!-- Prerequisites Section (Collapsible) -->
        <div id="prerequisites-section">
          <div class="card-header" id="prereq-header">
            <h2 style="font-size: 0.9rem; margin: 0;">Prerequisites</h2>
            <button class="card-toggle" id="prereq-toggle">
              <span class="prereq-status" id="prereq-status"></span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>
          <div class="card-content" id="prereq-content" style="margin-top: 0.5rem;">
            <div class="check-item" id="docker-check">
              <div class="check-icon pending" data-icon>?</div>
              <div class="check-info">
                <div class="check-name">Docker</div>
                <div class="check-version" data-version>Checking...</div>
              </div>
              <div class="check-action" data-action></div>
            </div>
            <div class="check-item" id="tailscale-check">
              <div class="check-icon pending" data-icon>?</div>
              <div class="check-info">
                <div class="check-name">Tailscale</div>
                <div class="check-version" data-version>Checking...</div>
              </div>
              <div class="check-action" data-action></div>
            </div>
            <div class="check-item" id="git-check">
              <div class="check-icon pending" data-icon>?</div>
              <div class="check-info">
                <div class="check-name">Git</div>
                <div class="check-version" data-version>Checking...</div>
              </div>
              <div class="check-action" data-action></div>
            </div>
          </div>
        </div>

        <div class="column-header" style="margin-top: 1rem;">Shared Infrastructure</div>
        <div id="infra-list" class="services-list"></div>
        <button class="btn btn-primary" id="toggle-infra-btn" style="margin-top: 1rem; width: 100%;" disabled>
          Start Infrastructure
        </button>
      </div>

      <!-- Right Column: Ushadow Environments -->
      <div class="card" id="envs-card">
        <div class="column-header">Ushadow Environments</div>
        <div id="envs-list">
          <div class="no-envs">Scanning for environments...</div>
        </div>
        <button class="btn btn-primary create-env-btn hidden" id="create-env-btn" style="margin-top: 1rem; width: 100%;">
          + Create Environment
        </button>
      </div>
    </div>

    <!-- Log Card -->
    <div class="card" id="log-card">
      <h2>Log</h2>
      <div class="log-area" id="log-area"></div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <span id="footer-status">Launcher v0.1.0</span>
      <span id="footer-url"></span>
    </div>
  </div>

  <!-- Floating Refresh Button -->
  <button class="refresh-btn" id="refresh-btn" data-testid="refresh-btn" title="Refresh status">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="23 4 23 10 17 10"></polyline>
      <polyline points="1 20 1 14 7 14"></polyline>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
    </svg>
  </button>


  <script>
    // Wait for Tauri API to be ready
    document.addEventListener('DOMContentLoaded', async function() {
      // Check if Tauri is available
      if (!window.__TAURI__) {
        document.getElementById('error-banner').textContent = 'Tauri API not available. Make sure you are running in the Tauri app.';
        document.getElementById('error-banner').classList.remove('hidden');
        return;
      }

      const { invoke } = window.__TAURI__.tauri;
      const { listen } = window.__TAURI__.event;

    // State
    let projectRoot = null;
    let prerequisites = null;
    let isStarting = false;
    let isLaunching = false; // Track if we're in launch sequence

    // Elements
    const errorBanner = document.getElementById('error-banner');
    const dockerCheck = document.getElementById('docker-check');
    const tailscaleCheck = document.getElementById('tailscale-check');
    const gitCheck = document.getElementById('git-check');
    const toggleInfraBtn = document.getElementById('toggle-infra-btn');
    const logCard = document.getElementById('log-card');
    const logArea = document.getElementById('log-area');
    const footerUrl = document.getElementById('footer-url');
    const infraList = document.getElementById('infra-list');
    const envsList = document.getElementById('envs-list');
    const prereqSection = document.getElementById('prerequisites-section');
    const prereqHeader = document.getElementById('prereq-header');
    const prereqStatus = document.getElementById('prereq-status');
    const launchContainer = document.getElementById('launch-container');
    const launchBtn = document.getElementById('launch-btn');
    const createEnvBtn = document.getElementById('create-env-btn');
    const twoColumn = document.querySelector('.two-column');
    const refreshBtn = document.getElementById('refresh-btn');

    // Show error
    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.classList.remove('hidden');
    }

    // Detect platform
    async function getPlatform() {
      try {
        // Try to use Tauri's OS detection
        const osType = await invoke('get_os_type');
        return osType;
      } catch (err) {
        // Fallback to user agent detection
        const ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf('win') > -1) return 'windows';
        if (ua.indexOf('mac') > -1) return 'macos';
        if (ua.indexOf('linux') > -1) return 'linux';
        return 'unknown';
      }
    }

    // Get platform-specific installation URLs
    function getInstallUrls(platform) {
      const urls = {
        docker: {
          macos: 'https://docs.docker.com/desktop/install/mac-install/',
          windows: 'https://docs.docker.com/desktop/install/windows-install/',
          linux: 'https://docs.docker.com/engine/install/',
          unknown: 'https://docs.docker.com/get-docker/'
        },
        tailscale: {
          macos: 'https://tailscale.com/download/mac',
          windows: 'https://tailscale.com/download/windows',
          linux: 'https://tailscale.com/download/linux',
          unknown: 'https://tailscale.com/download'
        },
        git: {
          macos: 'https://git-scm.com/download/mac',
          windows: 'https://git-scm.com/download/win',
          linux: 'https://git-scm.com/download/linux',
          unknown: 'https://git-scm.com/downloads'
        }
      };

      return {
        docker: urls.docker[platform] || urls.docker.unknown,
        tailscale: urls.tailscale[platform] || urls.tailscale.unknown,
        git: urls.git[platform] || urls.git.unknown
      };
    }

    // Detect project root - checks for existing installation or prompts for location
    async function detectProjectRoot() {
      try {
        // Get the default project directory for this platform
        const defaultDir = await invoke('get_default_project_dir');
        log('Default project directory: ' + defaultDir);

        // Check if the default directory has a valid Ushadow installation
        const projectStatus = await invoke('check_project_dir', { path: defaultDir });
        log('Project status: exists=' + projectStatus.exists + ', valid=' + projectStatus.is_valid_repo);

        if (projectStatus.exists && projectStatus.is_valid_repo) {
          // Valid installation found
          projectRoot = defaultDir;
          await invoke('set_project_root', { path: projectRoot });
          log('Project root set to: ' + projectRoot);
          return true;
        }

        // No valid installation - we'll need to clone during launch
        // For now, just set the target directory
        projectRoot = defaultDir;
        log('No existing project found. Will clone to: ' + projectRoot);
        return false;
      } catch (err) {
        log('Error detecting project root: ' + err, 'error');
        // Fall back to default
        try {
          projectRoot = await invoke('get_default_project_dir');
          log('Using default project directory: ' + projectRoot);
        } catch (e) {
          // Last resort fallback
          projectRoot = null;
          log('Could not determine project directory', 'error');
        }
        return false;
      }
    }

    // Clone the Ushadow repository
    async function cloneUshadowRepo(targetDir) {
      log('Cloning Ushadow repository to ' + targetDir + '...');
      try {
        const result = await invoke('clone_ushadow_repo', { targetDir: targetDir });
        log(result);
        return true;
      } catch (err) {
        log('Clone failed: ' + err, 'error');
        return false;
      }
    }

    // Prompt user for project directory
    async function promptForProjectDir() {
      const defaultDir = await invoke('get_default_project_dir');
      const userInput = prompt(
        'Enter the directory where Ushadow should be installed:\n' +
        '(Leave blank for default location)',
        defaultDir
      );

      if (userInput === null) {
        // User cancelled
        return null;
      }

      return userInput.trim() || defaultDir;
    }

    // Update check item UI using safe DOM methods
    function updateCheckItem(element, success, version, installUrl, installText) {
      const icon = element.querySelector('[data-icon]');
      const versionEl = element.querySelector('[data-version]');
      const actionEl = element.querySelector('[data-action]');

      icon.className = 'check-icon ' + (success ? 'success' : 'error');
      icon.textContent = success ? '‚úì' : '‚úó';
      versionEl.textContent = version || (success ? 'Installed' : 'Not found');

      // Clear existing action content safely
      while (actionEl.firstChild) {
        actionEl.removeChild(actionEl.firstChild);
      }

      // Add install link if needed
      if (installUrl && installText) {
        const link = document.createElement('a');
        link.href = installUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = installText;
        actionEl.appendChild(link);
      } else if (installText) {
        actionEl.textContent = installText;
      }
    }

    // Toggle prerequisites section collapse
    function togglePrereqSection() {
      prereqSection.classList.toggle('collapsed');
    }

    // Update prerequisites status badge
    function updatePrereqStatusBadge(allPassed, dockerOk, tailscaleOk) {
      if (allPassed) {
        prereqStatus.textContent = 'All passed';
        prereqStatus.className = 'prereq-status';
      } else if (dockerOk) {
        prereqStatus.textContent = 'Tailscale missing';
        prereqStatus.className = 'prereq-status warning';
      } else {
        prereqStatus.textContent = 'Action required';
        prereqStatus.className = 'prereq-status error';
      }
    }

    // Check prerequisites
    async function checkPrerequisites() {
      try {
        log('Checking prerequisites...');
        prerequisites = await invoke('check_prerequisites');
        log('Prerequisites result: Docker=' + prerequisites.docker_installed + ', Git=' + prerequisites.git_installed + ', Tailscale=' + prerequisites.tailscale_installed);

        // Update Docker UI
        const dockerOk = prerequisites.docker_installed && prerequisites.docker_running;
        updateCheckItem(
          dockerCheck,
          dockerOk,
          prerequisites.docker_version,
          !prerequisites.docker_installed ? 'https://docker.com/products/docker-desktop' : null,
          !prerequisites.docker_installed ? 'Install' : (!prerequisites.docker_running ? 'Start Docker Desktop' : null)
        );

        // Update Git UI (required for cloning)
        const gitOk = prerequisites.git_installed;
        updateCheckItem(
          gitCheck,
          gitOk,
          prerequisites.git_version,
          !prerequisites.git_installed ? 'https://git-scm.com/downloads' : null,
          !prerequisites.git_installed ? 'Install' : null
        );

        // Update Tailscale UI (considered optional - only warn, don't block)
        const tailscaleOk = prerequisites.tailscale_installed;
        updateCheckItem(
          tailscaleCheck,
          tailscaleOk,
          prerequisites.tailscale_version,
          !prerequisites.tailscale_installed ? 'https://tailscale.com/download' : null,
          !prerequisites.tailscale_installed ? 'Install (optional)' : null
        );

        // Enable toggle button if Docker is ready
        const canStart = dockerOk;
        toggleInfraBtn.disabled = !canStart;

        // Update status badge and auto-collapse if all required are OK
        // Git and Docker are required, Tailscale is optional
        const requiredOk = dockerOk && gitOk;
        const allPassed = requiredOk && tailscaleOk;
        updatePrereqStatusBadge(allPassed, requiredOk, gitOk);

        // Auto-collapse if required prerequisites are OK
        if (requiredOk && !prereqSection.classList.contains('collapsed')) {
          prereqSection.classList.add('collapsed');
        }

        return requiredOk;
      } catch (err) {
        log('Error checking prerequisites: ' + err, 'error');
        showError('Failed to check prerequisites: ' + err);
        return false;
      }
    }

    // Render infrastructure services list
    function renderInfraList(infrastructure) {
      log('Rendering ' + (infrastructure ? infrastructure.length : 0) + ' infra services');
      console.log('Infra data:', infrastructure);

      // Clear existing
      while (infraList.firstChild) {
        infraList.removeChild(infraList.firstChild);
      }

      if (!infrastructure || infrastructure.length === 0) {
        const noServices = document.createElement('div');
        noServices.className = 'no-envs';
        noServices.textContent = 'No infrastructure services running';
        infraList.appendChild(noServices);
        return;
      }

      infrastructure.forEach(function(service) {
        const item = document.createElement('div');
        item.className = 'service-item';

        const icon = document.createElement('div');
        icon.className = 'service-icon ' + (service.running ? 'running' : 'stopped');

        const name = document.createElement('span');
        name.className = 'service-name';
        name.textContent = service.display_name;

        const statusEl = document.createElement('span');
        statusEl.className = 'service-status';
        statusEl.textContent = service.running ? 'Running' : 'Stopped';

        item.appendChild(icon);
        item.appendChild(name);
        item.appendChild(statusEl);
        infraList.appendChild(item);
      });
    }

    // Get color class for environment
    function getEnvColorClass(color) {
      const validColors = ['blue', 'purple', 'green', 'red', 'orange', 'yellow', 'pink', 'cyan', 'teal', 'indigo'];
      return validColors.includes(color.toLowerCase()) ? 'env-color-' + color.toLowerCase() : 'env-color-default';
    }

    // Render environment cards
    function renderEnvironments(environments) {
      log('Rendering ' + (environments ? environments.length : 0) + ' environments');
      console.log('Environments data:', environments);

      // Clear existing
      while (envsList.firstChild) {
        envsList.removeChild(envsList.firstChild);
      }

      if (!environments || environments.length === 0) {
        const noEnvs = document.createElement('div');
        noEnvs.className = 'no-envs';
        noEnvs.textContent = 'No Ushadow environments running';
        envsList.appendChild(noEnvs);

        // Show create environment button
        createEnvBtn.classList.remove('hidden');
        return;
      }

      // Hide create environment button when envs exist
      createEnvBtn.classList.add('hidden');

      environments.forEach(function(env) {
        const card = document.createElement('div');
        const colorClass = getEnvColorClass(env.color);
        card.className = 'env-card running ' + colorClass;
        card.setAttribute('data-testid', 'env-card-' + env.name);

        // Header with dot and name
        const header = document.createElement('div');
        header.className = 'env-header';

        const dot = document.createElement('div');
        dot.className = 'env-dot';

        const name = document.createElement('span');
        name.className = 'env-name';
        name.textContent = env.name;

        header.appendChild(dot);
        header.appendChild(name);
        card.appendChild(header);

        // URLs section
        const urls = document.createElement('div');
        urls.className = 'env-urls';

        // Localhost URL
        const localhostRow = document.createElement('div');
        localhostRow.className = 'env-url';

        const localhostLabel = document.createElement('span');
        localhostLabel.className = 'env-url-label';
        localhostLabel.textContent = 'Local:';

        const localhostLink = document.createElement('a');
        localhostLink.href = '#';
        localhostLink.textContent = env.localhost_url;
        localhostLink.onclick = function(e) {
          e.preventDefault();
          openInApp(env.localhost_url, env.name);
        };

        localhostRow.appendChild(localhostLabel);
        localhostRow.appendChild(localhostLink);
        urls.appendChild(localhostRow);

        // Tailscale URL (if available)
        if (env.tailscale_url) {
          const tailscaleRow = document.createElement('div');
          tailscaleRow.className = 'env-url';

          const tailscaleLabel = document.createElement('span');
          tailscaleLabel.className = 'env-url-label';
          tailscaleLabel.textContent = 'Tailscale:';

          const tailscaleLink = document.createElement('a');
          tailscaleLink.href = '#';
          tailscaleLink.textContent = env.tailscale_url.replace('https://', '');
          tailscaleLink.onclick = function(e) {
            e.preventDefault();
            openInApp(env.tailscale_url, env.name);
          };

          tailscaleRow.appendChild(tailscaleLabel);
          tailscaleRow.appendChild(tailscaleLink);
          urls.appendChild(tailscaleRow);
        }

        card.appendChild(urls);

        // Actions: Open buttons and padlock
        const actions = document.createElement('div');
        actions.className = 'env-actions';

        // Open in app button
        const openAppBtn = document.createElement('button');
        openAppBtn.className = 'env-open-btn';
        openAppBtn.setAttribute('data-testid', 'env-open-app-' + env.name);
        openAppBtn.onclick = function() {
          openInApp(env.tailscale_url || env.localhost_url, env.name);
        };

        const appIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        appIcon.setAttribute('viewBox', '0 0 24 24');
        appIcon.setAttribute('fill', 'none');
        appIcon.setAttribute('stroke', 'currentColor');
        appIcon.setAttribute('stroke-width', '2');
        const appIconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        appIconPath.setAttribute('d', 'M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2');
        appIcon.appendChild(appIconPath);
        openAppBtn.appendChild(appIcon);
        openAppBtn.appendChild(document.createTextNode('Open in App'));
        actions.appendChild(openAppBtn);

        // Open in browser button
        const openBrowserBtn = document.createElement('button');
        openBrowserBtn.className = 'env-open-btn';
        openBrowserBtn.setAttribute('data-testid', 'env-open-browser-' + env.name);
        openBrowserBtn.onclick = function() {
          openInBrowser(env.tailscale_url || env.localhost_url);
        };

        const browserIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        browserIcon.setAttribute('viewBox', '0 0 24 24');
        browserIcon.setAttribute('fill', 'none');
        browserIcon.setAttribute('stroke', 'currentColor');
        browserIcon.setAttribute('stroke-width', '2');
        const browserCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        browserCircle.setAttribute('cx', '12');
        browserCircle.setAttribute('cy', '12');
        browserCircle.setAttribute('r', '10');
        const browserLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        browserLine1.setAttribute('x1', '2');
        browserLine1.setAttribute('y1', '12');
        browserLine1.setAttribute('x2', '22');
        browserLine1.setAttribute('y2', '12');
        const browserPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        browserPath.setAttribute('d', 'M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z');
        browserIcon.appendChild(browserCircle);
        browserIcon.appendChild(browserLine1);
        browserIcon.appendChild(browserPath);
        openBrowserBtn.appendChild(browserIcon);
        openBrowserBtn.appendChild(document.createTextNode('Browser'));
        actions.appendChild(openBrowserBtn);

        // Tailscale status padlock
        const padlock = document.createElement('button');
        padlock.className = 'env-icon-btn' + (env.tailscale_active ? ' secure' : '');
        padlock.title = env.tailscale_active
          ? 'Tailscale connected - Secure access available'
          : 'Localhost only';
        padlock.setAttribute('data-testid', 'env-padlock-' + env.name);

        const padlockSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        padlockSvg.setAttribute('viewBox', '0 0 24 24');
        padlockSvg.setAttribute('fill', 'none');
        padlockSvg.setAttribute('stroke', 'currentColor');
        padlockSvg.setAttribute('stroke-width', '2');

        if (env.tailscale_active) {
          // Locked padlock
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', '3');
          rect.setAttribute('y', '11');
          rect.setAttribute('width', '18');
          rect.setAttribute('height', '11');
          rect.setAttribute('rx', '2');
          rect.setAttribute('ry', '2');
          padlockSvg.appendChild(rect);

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', 'M7 11V7a5 5 0 0 1 10 0v4');
          padlockSvg.appendChild(path);
        } else {
          // Unlocked padlock
          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', '3');
          rect.setAttribute('y', '11');
          rect.setAttribute('width', '18');
          rect.setAttribute('height', '11');
          rect.setAttribute('rx', '2');
          rect.setAttribute('ry', '2');
          padlockSvg.appendChild(rect);

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', 'M7 11V7a5 5 0 0 1 9.9-1');
          padlockSvg.appendChild(path);
        }

        padlock.appendChild(padlockSvg);
        actions.appendChild(padlock);

        card.appendChild(actions);
        envsList.appendChild(card);
      });
    }

    // Open URL in app window (navigate current window)
    async function openInApp(url, envName) {
      try {
        console.log('Navigating to environment in app:', { url: url, envName: envName });
        log('Opening ' + envName + ' in app...');

        // Navigate the current window to the environment URL
        window.location.href = url;
      } catch (err) {
        console.error('Failed to navigate to environment:', err);
        log('Failed to navigate: ' + err, 'error');
        // Fallback to browser
        openInBrowser(url);
      }
    }

    // Open URL in external browser
    async function openInBrowser(url) {
      try {
        await invoke('open_browser', { url: url });
        log('Opened in browser: ' + url);
      } catch (err) {
        log('Failed to open browser: ' + err, 'error');
        // Last resort fallback
        window.open(url, '_blank');
      }
    }

    // Discover and render environments
    async function discoverEnvironments() {
      try {
        log('Calling discover_environments...');
        const discovery = await invoke('discover_environments');
        log('Discovery result: ' + JSON.stringify(discovery));
        console.log('Discovery:', discovery);

        // Check if anything is running
        const runningInfra = discovery.infrastructure.filter(function(s) { return s.running; }).length;
        const infraRunning = runningInfra > 0;
        const hasEnvs = discovery.environments && discovery.environments.length > 0;

        // Show/hide launch button vs two-column layout
        // Don't change UI if we're in the middle of launching
        if (!isLaunching) {
          if (!infraRunning && !hasEnvs) {
            // Nothing running - show big launch button
            launchContainer.classList.remove('hidden');
            twoColumn.classList.add('hidden');

            // Always enable launch button - it handles prerequisite installation
            launchBtn.disabled = false;
            log('Launch container shown - button enabled');
          } else {
            // Something running - show normal UI
            launchContainer.classList.add('hidden');
            twoColumn.classList.remove('hidden');
          }
        }

        // Render infrastructure
        renderInfraList(discovery.infrastructure);

        // Update toggle button based on infrastructure
        if (infraRunning) {
          toggleInfraBtn.textContent = 'Stop Infrastructure';
          toggleInfraBtn.classList.remove('btn-primary');
          toggleInfraBtn.classList.add('btn-secondary');
          toggleInfraBtn.disabled = false;
        } else {
          toggleInfraBtn.textContent = 'Start Infrastructure';
          toggleInfraBtn.classList.remove('btn-secondary');
          toggleInfraBtn.classList.add('btn-primary');
          toggleInfraBtn.disabled = !prerequisites?.docker_running;
        }

        // Render environments
        renderEnvironments(discovery.environments);

        // Enable/disable create environment button
        // Only enable if prerequisites pass AND infrastructure is running
        const canCreateEnv = prerequisites?.docker_running && infraRunning;
        createEnvBtn.disabled = !canCreateEnv;

        if (!canCreateEnv) {
          if (!prerequisites?.docker_running) {
            log('Create environment disabled: Docker not running');
          } else if (!infraRunning) {
            log('Create environment disabled: Infrastructure not running');
          }
        }

        return discovery;
      } catch (err) {
        log('Error discovering environments: ' + err, 'error');
        console.error('Discovery error:', err);
        return { infrastructure: [], environments: [] };
      }
    }

    // Legacy function for backward compatibility
    async function checkContainerStatus() {
      return discoverEnvironments();
    }

    // Log message
    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      const timestamp = new Date().toLocaleTimeString();
      line.textContent = '[' + timestamp + '] ' + message;
      logArea.appendChild(line);
      logArea.scrollTop = logArea.scrollHeight;
    }

    // Set button loading state
    function setButtonLoading(button, isLoading, loadingText, normalText) {
      while (button.firstChild) {
        button.removeChild(button.firstChild);
      }

      if (isLoading) {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        button.appendChild(spinner);
        button.appendChild(document.createTextNode(loadingText));
      } else {
        button.textContent = normalText;
      }
    }

    // Show creating status in UI (replaces button)
    function showCreatingStatus(section, message) {
      // Find and hide the button
      const button = section.querySelector('.btn');
      if (button) {
        button.classList.add('hidden');
      }

      // Remove existing badge
      const existingBadge = section.querySelector('.creating-badge');
      if (existingBadge) {
        existingBadge.remove();
      }

      // Add creating badge with spinner
      const badge = document.createElement('div');
      badge.className = 'creating-badge';

      const spinner = document.createElement('div');
      spinner.className = 'spinner';

      const text = document.createTextNode(message);

      badge.appendChild(spinner);
      badge.appendChild(text);

      // Insert after the services list or at the end
      section.appendChild(badge);
      section.classList.add('creating');
    }

    // Remove creating status and restore button
    function hideCreatingStatus(section) {
      const badge = section.querySelector('.creating-badge');
      if (badge) {
        badge.remove();
      }

      // Show the button again
      const button = section.querySelector('.btn');
      if (button) {
        button.classList.remove('hidden');
      }

      section.classList.remove('creating');
    }

    // Launch Ushadow (full setup)
    async function launchUshadow() {
      console.log('Launch button clicked!');
      log('üöÄ Launch button clicked');

      if (isStarting) {
        log('Already starting, please wait...', 'info');
        return;
      }

      isStarting = true;
      isLaunching = true; // Mark that we're in launch sequence
      launchBtn.disabled = true;
      setButtonLoading(launchBtn, true, 'Checking prerequisites...', 'üöÄ Launch Ushadow');

      log('üöÄ Starting Ushadow launch sequence...');

      // Detect platform for correct install URLs
      const platform = await getPlatform();

      try {
        // Animate to show two-column layout with prerequisites
        launchContainer.classList.add('hiding');
        await new Promise(resolve => setTimeout(resolve, 300));

        launchContainer.classList.add('hidden');
        launchContainer.classList.remove('hiding');

        twoColumn.classList.remove('hidden');
        twoColumn.classList.add('showing');

        // Remove 'showing' class after animation completes
        setTimeout(function() {
          twoColumn.classList.remove('showing');
        }, 500);

        // Expand prerequisites section to show progress
        prereqSection.classList.remove('collapsed');

        // Step 1: Check and install prerequisites
        log('Step 1/3: Checking prerequisites...');
        const prereqStatusEl = prereqSection.querySelector('.prereq-status');
        if (prereqStatusEl) {
          prereqStatusEl.textContent = 'Checking...';
          prereqStatusEl.className = 'prereq-status';
        }

        await checkPrerequisites();

        console.log('Prerequisites check result:', prerequisites);

        // Get platform-specific install URLs
        const installUrls = getInstallUrls(platform);

        // If Git is not installed, install it first (required for cloning)
        if (!prerequisites?.git_installed) {
          log('Git is not installed. Installing for ' + platform + '...', 'error');
          prereqStatusEl.textContent = 'Installing Git...';
          prereqStatusEl.className = 'prereq-status warning';

          if (platform === 'macos') {
            // On macOS, Git is usually installed with Xcode CLI tools
            try {
              log('Attempting to install Git via Homebrew...');
              const gitResult = await invoke('install_git_macos');
              log(gitResult);
            } catch (err) {
              log('Homebrew Git installation failed: ' + err, 'warning');
              log('Git may be available via Xcode CLI tools. Try: xcode-select --install');
              await invoke('open_browser', { url: installUrls.git });
            }
          } else if (platform === 'windows') {
            // On Windows, try winget first
            try {
              log('Attempting to install Git via winget...');
              const gitResult = await invoke('install_git_windows');
              log(gitResult);
            } catch (err) {
              log('Winget Git installation failed: ' + err, 'warning');
              await invoke('open_browser', { url: installUrls.git });
              log('‚è≥ Please install Git and restart the launcher...');
            }
          } else {
            // Linux - open download page
            await invoke('open_browser', { url: installUrls.git });
            log('‚è≥ Please install Git using your package manager:');
            log('   Ubuntu/Debian: sudo apt-get install git');
            log('   Fedora: sudo dnf install git');
          }

          // Poll for Git installation (check every 5 seconds)
          while (!prerequisites?.git_installed) {
            await new Promise(resolve => setTimeout(resolve, 5000));
            await checkPrerequisites();
          }

          log('‚úÖ Git is now installed!');
        }

        // If Docker is not installed, open installer and wait
        if (!prerequisites?.docker_installed) {
          log('Docker is not installed. Installing for ' + platform + '...', 'error');
          prereqStatusEl.textContent = 'Installing Docker...';
          prereqStatusEl.className = 'prereq-status warning';

          if (platform === 'macos') {
            // Auto-install via Homebrew on macOS
            try {
              log('üç∫ Installing Docker via Homebrew...');
              const brewResult = await invoke('install_docker_via_brew');
              log(brewResult);
              log('‚úÖ Docker installed successfully!');
              log('Starting Docker Desktop...');

              // Start Docker Desktop
              try {
                const startResult = await invoke('start_docker_desktop_macos');
                log(startResult);
              } catch (startErr) {
                log('Failed to auto-start Docker: ' + startErr, 'warning');
                log('‚è≥ Please start Docker Desktop manually...');
              }
            } catch (brewErr) {
              log('Homebrew installation failed: ' + brewErr, 'error');
              log('Opening Docker download page instead...');
              await invoke('open_browser', { url: installUrls.docker });
              log('‚è≥ Please install Docker Desktop manually and start it...');
            }
          } else if (platform === 'linux') {
            // Open instructions for Linux (manual installation required)
            await invoke('open_browser', { url: installUrls.docker });
            log('‚è≥ Please install Docker using your package manager, then start the Docker service.');
            log('   Ubuntu/Debian: sudo apt-get install docker.io && sudo systemctl start docker');
            log('   Fedora: sudo dnf install docker && sudo systemctl start docker');
            log('   Then this will continue automatically...');
          } else {
            // Windows - open installer
            await invoke('open_browser', { url: installUrls.docker });
            log('‚è≥ Please install Docker Desktop and start it...');
            log('   After installation completes, Docker Desktop should start automatically...');
          }

          // Poll for Docker installation (check every 5 seconds)
          while (!prerequisites?.docker_installed || !prerequisites?.docker_running) {
            await new Promise(resolve => setTimeout(resolve, 5000));
            await checkPrerequisites();

            if (prerequisites?.docker_installed && !prerequisites?.docker_running) {
              log('Docker installed! Waiting for Docker to start...');
              prereqStatusEl.textContent = 'Starting Docker...';

              // Auto-start Docker Desktop on Windows after installation
              if (platform === 'windows') {
                try {
                  log('Attempting to start Docker Desktop...');
                  const startResult = await invoke('start_docker_desktop_windows');
                  log(startResult);
                } catch (err) {
                  log('Auto-start attempt: ' + err, 'info');
                }
              }
            }
          }

          log('‚úÖ Docker is now running!');
        } else if (!prerequisites?.docker_running) {
          log('Docker is installed but not running. Starting Docker...', 'error');
          prereqStatusEl.textContent = 'Starting Docker...';
          prereqStatusEl.className = 'prereq-status warning';

          if (platform === 'macos') {
            try {
              log('Starting Docker Desktop on macOS...');
              const startResult = await invoke('start_docker_desktop_macos');
              log(startResult);
            } catch (err) {
              log('Failed to auto-start Docker: ' + err, 'warning');
              log('‚è≥ Please start Docker Desktop manually...');
            }
          } else if (platform === 'windows') {
            try {
              log('Starting Docker Desktop on Windows...');
              const startResult = await invoke('start_docker_desktop_windows');
              log(startResult);
            } catch (err) {
              log('Failed to auto-start Docker: ' + err, 'warning');
              log('‚è≥ Please start Docker Desktop manually...');
            }
          } else if (platform === 'linux') {
            try {
              log('Starting Docker service on Linux...');
              const startResult = await invoke('start_docker_service_linux');
              log(startResult);
            } catch (err) {
              log('Failed to auto-start Docker: ' + err, 'warning');
              log('‚è≥ Please start Docker service manually: sudo systemctl start docker');
            }
          }

          // Poll for Docker to start
          while (!prerequisites?.docker_running) {
            await new Promise(resolve => setTimeout(resolve, 3000));
            await checkPrerequisites();
          }

          log('‚úÖ Docker is now running!');
        }

        // Check Tailscale (optional but recommended)
        if (!prerequisites?.tailscale_installed) {
          log('Tailscale is not installed (optional). Opening installer for ' + platform + '...', 'warning');
          await invoke('open_browser', { url: installUrls.tailscale });
          log('You can install Tailscale later for remote access.');
        }

        // Prerequisites satisfied!
        prereqStatusEl.textContent = 'All ready';
        prereqStatusEl.className = 'prereq-status';

        // Auto-collapse prerequisites after success
        await new Promise(resolve => setTimeout(resolve, 1000));
        prereqSection.classList.add('collapsed');

        // Step 1.5: Ensure Ushadow repository is set up
        log('Checking Ushadow installation...');
        setButtonLoading(launchBtn, true, 'Setting up...', 'üöÄ Launch Ushadow');

        // Ensure we have a project directory path
        if (!projectRoot) {
          log('No project directory set, getting default...');
          projectRoot = await invoke('get_default_project_dir');
        }

        // Check if we already have a valid project
        const projectStatus = await invoke('check_project_dir', { path: projectRoot });

        if (!projectStatus.exists || !projectStatus.is_valid_repo) {
          log('Ushadow not found at: ' + projectRoot);

          // Ask user if they want to use default location or choose another
          const useDefault = confirm(
            'Ushadow needs to be downloaded to your computer.\n\n' +
            'Default location: ' + projectRoot + '\n\n' +
            'Click OK to use this location, or Cancel to choose a different folder.'
          );

          if (!useDefault) {
            const customDir = await promptForProjectDir();
            if (customDir === null) {
              throw new Error('Installation cancelled by user');
            }
            projectRoot = customDir;
            log('Custom installation directory: ' + projectRoot);
          }

          // Clone the repository
          log('Downloading Ushadow to: ' + projectRoot + '...');
          prereqStatusEl.textContent = 'Downloading...';
          prereqStatusEl.className = 'prereq-status starting';

          const cloneSuccess = await cloneUshadowRepo(projectRoot);

          if (!cloneSuccess) {
            throw new Error('Failed to download Ushadow repository. Please check your internet connection and try again.');
          }

          log('Ushadow downloaded successfully!');
          prereqStatusEl.textContent = 'Downloaded';
          prereqStatusEl.className = 'prereq-status';
        } else {
          log('Found existing Ushadow installation at: ' + projectRoot);
        }

        // Set the project root in the backend
        await invoke('set_project_root', { path: projectRoot });
        log('Project root configured: ' + projectRoot);

        // Continue with launch
        setButtonLoading(launchBtn, true, 'Launching...', 'üöÄ Launch Ushadow');

        // Step 2: Start infrastructure
        log('Step 2/3: Starting infrastructure...');
        const infraCard = document.getElementById('infra-card');

        // Show placeholder services
        const placeholderServices = [
          { name: 'MongoDB', display_name: 'MongoDB', running: false },
          { name: 'Redis', display_name: 'Redis', running: false },
          { name: 'Neo4j', display_name: 'Neo4j', running: false },
          { name: 'Qdrant', display_name: 'Qdrant', running: false }
        ];
        renderInfraList(placeholderServices);
        showCreatingStatus(infraCard, 'Starting...');

        const startResult = await invoke('start_containers');
        log(startResult);

        // Wait a bit for services to start and show progress
        for (let i = 1; i <= 5; i++) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          log('Starting infrastructure... (' + i + '/5)');

          // Update service status to show starting animation
          const serviceItems = infraList.querySelectorAll('.service-item');
          serviceItems.forEach(function(item, index) {
            if (index < i - 1) {
              const icon = item.querySelector('.service-icon');
              const statusEl = item.querySelector('.service-status');
              if (icon && statusEl) {
                icon.className = 'service-icon running';
                statusEl.textContent = 'Running';
              }
            } else if (index === i - 1) {
              const icon = item.querySelector('.service-icon');
              const statusEl = item.querySelector('.service-status');
              if (icon && statusEl) {
                icon.className = 'service-icon starting';
                statusEl.textContent = 'Starting...';
              }
            }
          });
        }

        hideCreatingStatus(infraCard);
        await discoverEnvironments();

        // Step 3: Create default environment
        log('Step 3/3: Creating default environment...');
        const envsCard = document.getElementById('envs-card');

        // Show placeholder environment
        const placeholderEnv = {
          name: 'default',
          color: 'default',
          localhost_url: 'http://localhost:3000',
          backend_port: 8000,
          running: false,
          tailscale_active: false
        };

        // Clear and show creating message
        while (envsList.firstChild) {
          envsList.removeChild(envsList.firstChild);
        }
        const creating = document.createElement('div');
        creating.className = 'no-envs';
        creating.textContent = 'Creating default environment...';
        envsList.appendChild(creating);

        showCreatingStatus(envsCard, 'Creating...');

        const envResult = await invoke('create_environment', { name: null });
        log(envResult);

        // Wait for environment to be ready
        for (let i = 1; i <= 3; i++) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          log('Creating environment... (' + i + '/3)');
        }

        hideCreatingStatus(envsCard);

        // Poll for environment to be ready (with retries)
        let defaultEnv = null;
        for (let retry = 0; retry < 15; retry++) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          log('Checking if environment is ready... (' + (retry + 1) + '/15)');

          const discovery = await discoverEnvironments();
          if (discovery.environments && discovery.environments.length > 0) {
            defaultEnv = discovery.environments[0];
            log('‚úì Environment detected: ' + defaultEnv.name);
            break;
          }
        }

        if (defaultEnv) {
          // Verify we have a valid URL
          const url = defaultEnv.localhost_url;
          if (!url) {
            log('‚ö†Ô∏è No URL available for environment. Skipping auto-open.', 'error');
            return;
          }

          log('Environment URL: ' + url);

          // Poll for web UI to be ready
          log('Waiting for web UI to start...');
          const webuiPort = defaultEnv.webui_port || 3000;
          let webuiReady = false;

          for (let attempt = 0; attempt < 20; attempt++) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            log('Checking web UI health... (' + (attempt + 1) + '/20)');

            try {
              const healthy = await invoke('check_webui_health', { port: webuiPort });
              if (healthy) {
                webuiReady = true;
                log('‚úì Web UI is responding!');
                break;
              }
            } catch (err) {
              log('Web UI not ready yet...');
            }
          }

          if (!webuiReady) {
            log('‚ö†Ô∏è Web UI health check timed out, opening anyway...', 'warning');
          }

          log('‚úÖ Ushadow launched successfully!');
          log('Opening environment in app window...');

          // Open the default environment in-app (NOT in browser)
          try {
            await openInApp(url, defaultEnv.name);
            log('App window opened for: ' + defaultEnv.name);
          } catch (err) {
            log('Failed to open in app: ' + err, 'error');
            showError('Failed to open environment: ' + err);
          }
        } else {
          log('‚ö†Ô∏è Environment created but not detected after 30 seconds.', 'error');
          showError('Environment created but not detected. Please check the logs.');
        }

      } catch (err) {
        log('Failed to launch Ushadow: ' + err, 'error');
        showError('Failed to launch Ushadow: ' + err);

        // Clean up any creating badges
        hideCreatingStatus(document.getElementById('infra-card'));
        hideCreatingStatus(document.getElementById('envs-card'));
      } finally {
        isStarting = false;
        isLaunching = false; // Clear launch sequence flag
        setButtonLoading(launchBtn, false, 'Launching...', 'üöÄ Launch Ushadow');
        await discoverEnvironments();
      }
    }

    // Create new environment
    async function createNewEnvironment() {
      const envName = prompt('Enter environment name (or leave blank for "default"):');
      if (envName === null) return; // User cancelled

      createEnvBtn.disabled = true;
      setButtonLoading(createEnvBtn, true, 'Creating...', '+ Create Environment');

      log('Creating environment: ' + (envName || 'default'));

      try {
        const result = await invoke('create_environment', { name: envName || null });
        log(result);

        // Poll for environment to be ready (similar to launch flow)
        log('Waiting for environment to be ready...');
        let envDetected = false;

        for (let retry = 0; retry < 15; retry++) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          log('Checking if environment is ready... (' + (retry + 1) + '/15)');

          const discovery = await discoverEnvironments();
          if (discovery.environments && discovery.environments.length > 0) {
            envDetected = true;
            log('‚úì Environment detected and ready!');
            break;
          }
        }

        if (envDetected) {
          log('‚úÖ Environment created successfully!');
          // Discovery will hide the button and show the environment
        } else {
          log('‚ö†Ô∏è Environment created but not detected yet.', 'warning');
          // Re-enable button on timeout
          setButtonLoading(createEnvBtn, false, 'Creating...', '+ Create Environment');
          createEnvBtn.disabled = false;
        }
      } catch (err) {
        log('Failed to create environment: ' + err, 'error');
        showError('Failed to create environment: ' + err);
        // Re-enable button on error
        setButtonLoading(createEnvBtn, false, 'Creating...', '+ Create Environment');
        createEnvBtn.disabled = false;
      }
    }

    // Toggle infrastructure on/off
    async function toggleInfrastructure() {
      if (isStarting) return;

      // Check current state
      const discovery = await invoke('discover_environments');
      const runningInfra = discovery.infrastructure.filter(function(s) { return s.running; }).length;
      const infraRunning = runningInfra > 0;

      if (infraRunning) {
        // Stop infrastructure
        isStarting = true;
        toggleInfraBtn.disabled = true;
        setButtonLoading(toggleInfraBtn, true, 'Stopping...', 'Stop Infrastructure');
        statusText.textContent = 'Stopping infrastructure...';
        log('Stopping infrastructure...');

        try {
          const result = await invoke('stop_containers');
          log(result);
        } catch (err) {
          log('Failed to stop: ' + err, 'error');
        } finally {
          isStarting = false;
          setButtonLoading(toggleInfraBtn, false, '', 'Stop Infrastructure');
          await checkContainerStatus();
        }
      } else {
        // Start infrastructure
        isStarting = true;
        toggleInfraBtn.disabled = true;
        setButtonLoading(toggleInfraBtn, true, 'Starting...', 'Start Infrastructure');
        statusDot.className = 'status-dot starting';
        statusText.textContent = 'Starting infrastructure...';
        log('Starting infrastructure...');

        try {
          const result = await invoke('start_containers');
          log(result);
          log('Infrastructure started! Waiting for services...');

          // Poll for backend health
          let attempts = 0;
          const maxAttempts = 30;

          const checkHealth = async () => {
            attempts++;
            // Default to port 8000 for health checks
            const port = 8000;
            const healthy = await invoke('check_backend_health', { port: port });

            if (healthy) {
              log('Backend is healthy!');
              await checkContainerStatus();
            } else if (attempts < maxAttempts) {
              log('Waiting for backend... (' + attempts + '/' + maxAttempts + ')');
              setTimeout(checkHealth, 2000);
            } else {
              log('Backend health check timed out', 'error');
              await checkContainerStatus();
            }
          };

          setTimeout(checkHealth, 3000);
        } catch (err) {
          log('Failed to start: ' + err, 'error');
          statusDot.className = 'status-dot stopped';
          statusText.textContent = 'Failed to start';
        } finally {
          isStarting = false;
          setButtonLoading(toggleInfraBtn, false, '', 'Start Infrastructure');
          await checkContainerStatus();
        }
      }
    }

    // Event listeners
    toggleInfraBtn.addEventListener('click', toggleInfrastructure);
    prereqHeader.addEventListener('click', togglePrereqSection);

    launchBtn.addEventListener('click', function() {
      console.log('Launch button click event fired!');
      launchUshadow();
    });

    createEnvBtn.addEventListener('click', createNewEnvironment);

    // Manual refresh handler
    async function manualRefresh() {
      if (refreshBtn.classList.contains('spinning')) return;

      refreshBtn.classList.add('spinning');
      log('Manual refresh triggered');

      try {
        await checkPrerequisites();
        await checkContainerStatus();
        log('Refresh complete');
      } catch (err) {
        log('Refresh failed: ' + err, 'error');
      } finally {
        refreshBtn.classList.remove('spinning');
      }
    }

    refreshBtn.addEventListener('click', manualRefresh);

    console.log('All event listeners attached successfully');

    // Listen for tray events
    listen('tray-start', () => toggleInfrastructure());
    listen('tray-stop', () => toggleInfrastructure());

    // Initialize
    async function init() {
      log('Initializing Ushadow Launcher...');

      try {
        await detectProjectRoot();
        await checkPrerequisites();
        await checkContainerStatus();

        // Launch button is always enabled - it handles prerequisite installation
        launchBtn.disabled = false;
        log('Launcher initialized - Launch button ready');

        // Poll status every 60 seconds (reduced from 10s to minimize resource usage)
        // Use the manual refresh button for immediate updates
        setInterval(checkContainerStatus, 60000);
      } catch (err) {
        log('Initialization failed: ' + err, 'error');
        console.error('Init error:', err);
      }
    }

    // Verify event listeners are attached
    console.log('Launch button element:', launchBtn);
    console.log('Event listener will be attached after DOMContentLoaded');

    // Start initialization
    init();
    }); // End DOMContentLoaded
  </script>
</body>
</html>
